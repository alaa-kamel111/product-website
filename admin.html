<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin | Eng. Alaa Kamel Product Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #020617;
        color: #e5e7eb;
      }

      .shell {
        min-height: 100vh;
        display: flex;
      }

      .sidebar {
        width: 260px;
        background: radial-gradient(circle at top left, #1d4ed8, #020617);
        padding: 1.5rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        box-shadow: 4px 0 24px rgba(15, 23, 42, 0.8);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .brand-mark {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: conic-gradient(from 160deg, #22c55e, #2563eb, #facc15, #22c55e);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #020617;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.6);
      }

      .brand-text h1 {
        margin: 0;
        font-size: 1.05rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .brand-text p {
        margin: 0.15rem 0 0;
        font-size: 0.8rem;
        color: #c7d2fe;
      }

      .nav-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.86rem;
      }

      .nav-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: #9ca3af;
      }

      .nav-link {
        padding: 0.4rem 0.55rem;
        border-radius: 0.55rem;
        cursor: pointer;
        color: #e5e7eb;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-link.active {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(191, 219, 254, 0.5);
      }

      .nav-pill {
        padding: 0.2rem 0.45rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.4);
        font-size: 0.7rem;
        color: #bfdbfe;
      }

      .nav-footer {
        margin-top: auto;
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .nav-footer a {
        color: #bfdbfe;
        text-decoration: none;
      }

      .content {
        flex: 1;
        padding: 1.5rem 1.75rem 1.75rem;
        background: radial-gradient(circle at top left, #0b1120, #020617 55%);
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
      }

      .content-header h2 {
        margin: 0;
        font-size: 1.35rem;
      }

      .content-header p {
        margin: 0.15rem 0 0;
        font-size: 0.86rem;
        color: #9ca3af;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.65);
        font-size: 0.75rem;
        color: #c7d2fe;
      }

      .badge-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        padding: 0.6rem 1rem;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        text-decoration: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #ecfdf5;
        box-shadow: 0 10px 24px rgba(22, 163, 74, 0.45);
      }

      .btn-ghost {
        background: transparent;
        color: #e5e7eb;
        border: 1px solid rgba(148, 163, 184, 0.6);
      }

      .btn-ghost:hover {
        background: rgba(15, 23, 42, 0.7);
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.9fr) minmax(0, 1.3fr);
        gap: 1.25rem;
        align-items: flex-start;
      }

      .card {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 1rem;
        padding: 1rem 1.1rem 1.15rem;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(30, 64, 175, 0.65);
      }

      .card h3 {
        margin: 0 0 0.6rem;
        font-size: 1.05rem;
      }

      .card p {
        margin: 0 0 0.8rem;
        font-size: 0.82rem;
        color: #9ca3af;
      }

      .card-muted {
        background: radial-gradient(circle at top left, #111827, #020617);
        border-color: rgba(51, 65, 85, 0.9);
      }

      .login-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        gap: 1.25rem;
        align-items: center;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        font-size: 0.8rem;
      }

      .field label {
        color: #cbd5f5;
      }

      .field input {
        border-radius: 0.6rem;
        border: 1px solid rgba(55, 65, 81, 0.9);
        padding: 0.5rem 0.6rem;
        background: rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
        font-size: 0.86rem;
        outline: none;
      }

      .field input:focus {
        border-color: rgba(129, 140, 248, 0.9);
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
      }

      .hint {
        font-size: 0.76rem;
        color: #9ca3af;
      }

      .hint strong {
        color: #e5e7eb;
      }

      .status {
        margin-top: 0.5rem;
        font-size: 0.78rem;
        color: #9ca3af;
      }

      .status--error {
        color: #fecaca;
      }

      .tag-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.4rem;
      }

      .tag {
        font-size: 0.75rem;
        padding: 0.22rem 0.55rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        color: #d1d5db;
        border: 1px solid rgba(55, 65, 81, 0.9);
      }

      .products-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }

      .products-table th,
      .products-table td {
        padding: 0.4rem 0.35rem;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      }

      .products-table th {
        text-align: left;
        font-weight: 500;
        color: #9ca3af;
        font-size: 0.78rem;
      }

      .products-table tr:hover {
        background: rgba(15, 23, 42, 0.9);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.72rem;
      }

      .pill-green {
        background: rgba(22, 163, 74, 0.1);
        color: #4ade80;
      }

      .pill-blue {
        background: rgba(59, 130, 246, 0.1);
        color: #93c5fd;
      }

      .pill-ghost {
        background: rgba(15, 23, 42, 0.8);
        color: #e5e7eb;
        border: 1px solid rgba(75, 85, 99, 0.7);
      }

      .products-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.65rem;
        gap: 0.6rem;
      }

      .products-counter {
        font-size: 0.78rem;
        color: #9ca3af;
      }

      .products-counter strong {
        color: #e5e7eb;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.55rem 0.7rem;
      }

      .form-grid .field.full {
        grid-column: 1 / -1;
      }

      @media (max-width: 960px) {
        .shell {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          flex-direction: row;
          align-items: center;
        }

        .nav-footer {
          margin-top: 0;
        }

        .content {
          padding-inline: 1.1rem;
        }

        .grid,
        .login-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <aside class="sidebar">
        <div class="brand">
          <div class="brand-mark">AK</div>
          <div class="brand-text">
            <h1>ENG. ALAA</h1>
            <p>Product Store Admin</p>
          </div>
        </div>
        <div class="nav-group">
          <div class="nav-label">Dashboard</div>
          <div class="nav-link active">
            <span>Products</span>
            <span class="nav-pill" id="nav-role-pill">Guest</span>
          </div>
        </div>
        <div class="nav-footer">
          <div>Public store: <a href="index.html" target="_blank">Open website</a></div>
          <div id="nav-user-status">Not signed in</div>
        </div>
      </aside>

      <main class="content">
        <div class="content-header">
          <div>
            <h2>Product catalog control</h2>
            <p>Only Eng. Alaa Kamel can change prices or products. Visitors see the public list only.</p>
          </div>
          <div>
            <div class="badge">
              <span class="badge-dot"></span>
              <span id="badge-label">Admin locked</span>
            </div>
          </div>
        </div>

        <section class="card card-muted" id="login-card">
          <div class="login-grid">
            <div>
              <h3>Sign in as admin</h3>
              <p>
                Use your private admin password to unlock product management. Friends and customers never see
                this page or the password – they only see the public storefront.
              </p>
              <div class="tag-row">
                <span class="tag">Secure local dashboard</span>
                <span class="tag">Control prices &amp; availability</span>
                <span class="tag">WhatsApp‑ready products</span>
              </div>
            </div>
            <div>
              <form id="login-form">
                <div class="field">
                  <label for="username">Username</label>
                  <input id="username" type="text" required placeholder="admin" />
                </div>
                <div class="field">
                  <label for="password">Password</label>
                  <input id="password" type="password" required placeholder="Your admin password" />
                </div>
                <p class="hint">
                  Default admin account: <strong>admin</strong><br />
                  Default password: <strong>ENG/Alaa Kamel</strong> (you can change it later in the server config).
                </p>
                <div style="margin-top: 0.7rem; display: flex; gap: 0.5rem; align-items: center;">
                  <button type="submit" class="btn btn-primary">Sign in</button>
                  <span class="status status--error" id="login-status"></span>
                </div>
              </form>
            </div>
          </div>
        </section>

        <section class="grid" id="admin-grid" style="display: none;">
          <div class="card" id="products-card">
            <div class="products-toolbar">
              <div>
                <h3>Your products</h3>
                <p class="hint">Edit prices, names or categories. Changes are live for all visitors.</p>
              </div>
              <div class="products-counter" id="products-counter">0 products</div>
            </div>
            <table class="products-table" id="products-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Price</th>
                  <th>Category</th>
                  <th>Visibility</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="products-tbody"></tbody>
            </table>
          </div>

          <div class="card" id="editor-card">
            <h3 id="editor-title">Add / edit product</h3>
            <p class="hint">Fill the fields and save to update the public store instantly.</p>
            <form id="product-form">
              <input type="hidden" id="product-id" />
              <div class="form-grid">
                <div class="field">
                  <label for="product-name">Name</label>
                  <input id="product-name" type="text" required placeholder="e.g. Smart Desk Lamp" />
                </div>
                <div class="field">
                  <label for="product-price">Price</label>
                  <input id="product-price" type="number" min="0" step="0.01" required placeholder="39.00" />
                </div>
                <div class="field">
                  <label for="product-category">Category</label>
                  <input id="product-category" type="text" placeholder="Office, Electronics, Accessories" />
                </div>
                <div class="field">
                  <label for="product-image">Image URL</label>
                  <input id="product-image" type="url" placeholder="https://.../product.jpg" />
                </div>
                <div class="field full">
                  <label for="product-description">Description</label>
                  <input
                    id="product-description"
                    type="text"
                    placeholder="Short, clear sentence for your customers."
                  />
                </div>
              </div>
              <div style="margin-top: 0.8rem; display: flex; gap: 0.6rem; align-items: center;">
                <button type="submit" class="btn btn-primary" id="save-btn">Save product</button>
                <button type="button" class="btn btn-ghost" id="reset-btn">Reset</button>
                <span class="status" id="editor-status">Ready.</span>
              </div>
            </form>
          </div>
        </section>
      </main>
    </div>

    <script>
      (function () {
        const loginForm = document.getElementById('login-form');
        const loginStatus = document.getElementById('login-status');
        const loginCard = document.getElementById('login-card');
        const adminGrid = document.getElementById('admin-grid');
        const navRolePill = document.getElementById('nav-role-pill');
        const navUserStatus = document.getElementById('nav-user-status');
        const badgeLabel = document.getElementById('badge-label');

        const productsTbody = document.getElementById('products-tbody');
        const productsCounter = document.getElementById('products-counter');

        const form = document.getElementById('product-form');
        const editorTitle = document.getElementById('editor-title');
        const editorStatus = document.getElementById('editor-status');
        const saveBtn = document.getElementById('save-btn');
        const resetBtn = document.getElementById('reset-btn');

        const idInput = document.getElementById('product-id');
        const nameInput = document.getElementById('product-name');
        const priceInput = document.getElementById('product-price');
        const categoryInput = document.getElementById('product-category');
        const imageInput = document.getElementById('product-image');
        const descriptionInput = document.getElementById('product-description');

        let products = [];

        async function api(path, options) {
          const res = await fetch(path, {
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            },
            ...options
          });
          const text = await res.text();
          let data = null;
          try {
            data = text ? JSON.parse(text) : null;
          } catch (e) {
            data = null;
          }
          if (!res.ok) {
            const message = (data && data.error) || res.statusText || 'Request failed';
            throw new Error(message);
          }
          return data;
        }

        function setAuthUI(authenticated, username) {
          if (authenticated) {
            loginCard.style.display = 'none';
            adminGrid.style.display = 'grid';
            navRolePill.textContent = 'Admin';
            navRolePill.className = 'nav-pill';
            navUserStatus.textContent = 'Signed in as ' + (username || 'admin');
            badgeLabel.textContent = 'Admin session active';
          } else {
            loginCard.style.display = 'block';
            adminGrid.style.display = 'none';
            navRolePill.textContent = 'Guest';
            navRolePill.className = 'nav-pill';
            navUserStatus.textContent = 'Not signed in';
            badgeLabel.textContent = 'Admin locked';
          }
        }

        async function loadMe() {
          try {
            const me = await api('/api/me');
            setAuthUI(me.authenticated, me.username);
            if (me.authenticated) {
              await loadProducts();
            }
          } catch (e) {
            setAuthUI(false);
          }
        }

        async function loadProducts() {
          try {
            products = await api('/api/products', { method: 'GET' });
            renderProducts();
          } catch (e) {
            editorStatus.textContent = 'Could not load products: ' + e.message;
          }
        }

        function renderProducts() {
          productsTbody.innerHTML = '';
          products.forEach((p) => {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = p.name || 'Untitled product';

            const tdPrice = document.createElement('td');
            tdPrice.textContent = typeof p.price === 'number' ? '$' + p.price.toFixed(2) : '';

            const tdCategory = document.createElement('td');
            tdCategory.textContent = p.category || '-';

            const tdVisible = document.createElement('td');
            const pill = document.createElement('span');
            pill.className = 'pill pill-green';
            pill.textContent = 'Visible';
            tdVisible.appendChild(pill);

            const tdActions = document.createElement('td');
            tdActions.style.textAlign = 'right';

            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'pill pill-blue';
            editBtn.textContent = 'Edit';
            editBtn.style.marginRight = '0.25rem';
            editBtn.addEventListener('click', function () {
              startEdit(p.id);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'pill pill-ghost';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', function () {
              deleteProduct(p.id);
            });

            tdActions.appendChild(editBtn);
            tdActions.appendChild(deleteBtn);

            tr.appendChild(tdName);
            tr.appendChild(tdPrice);
            tr.appendChild(tdCategory);
            tr.appendChild(tdVisible);
            tr.appendChild(tdActions);

            productsTbody.appendChild(tr);
          });

          productsCounter.textContent = products.length + (products.length === 1 ? ' product' : ' products');
          editorStatus.textContent = 'Ready.';
        }

        function startEdit(id) {
          const p = products.find((x) => x.id === id);
          if (!p) return;

          idInput.value = p.id;
          nameInput.value = p.name || '';
          priceInput.value = p.price != null ? String(p.price) : '';
          categoryInput.value = p.category || '';
          imageInput.value = p.image || '';
          descriptionInput.value = p.description || '';

          editorTitle.textContent = 'Edit product';
          editorStatus.textContent = 'Editing "' + (p.name || 'product') + '"';
        }

        async function deleteProduct(id) {
          const p = products.find((x) => x.id === id);
          const name = p && p.name ? p.name : 'this product';
          const confirmed = window.confirm('Delete "' + name + '" from your store?');
          if (!confirmed) return;
          try {
            await api('/api/products/' + encodeURIComponent(id), { method: 'DELETE' });
            products = products.filter((x) => x.id !== id);
            renderProducts();
            resetEditor();
            editorStatus.textContent = 'Product removed.';
          } catch (e) {
            editorStatus.textContent = 'Delete failed: ' + e.message;
          }
        }

        function resetEditor() {
          idInput.value = '';
          form.reset();
          editorTitle.textContent = 'Add / edit product';
          editorStatus.textContent = 'Ready.';
        }

        if (loginForm) {
          loginForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            loginStatus.textContent = '';
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            try {
              await api('/api/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
              });
              loginStatus.textContent = '';
              await loadMe();
            } catch (e) {
              loginStatus.textContent = e.message || 'Login failed';
            }
          });
        }

        if (form) {
          form.addEventListener('submit', async function (event) {
            event.preventDefault();
            editorStatus.textContent = '';
            const id = idInput.value || null;
            const body = {
              name: nameInput.value.trim(),
              price: priceInput.value,
              category: categoryInput.value.trim(),
              image: imageInput.value.trim(),
              description: descriptionInput.value.trim()
            };
            try {
              if (id) {
                const updated = await api('/api/products/' + encodeURIComponent(id), {
                  method: 'PUT',
                  body: JSON.stringify(body)
                });
                const idx = products.findIndex((x) => x.id === id);
                if (idx !== -1) products[idx] = updated;
                editorStatus.textContent = 'Product updated.';
              } else {
                const created = await api('/api/products', {
                  method: 'POST',
                  body: JSON.stringify(body)
                });
                products.unshift(created);
                editorStatus.textContent = 'Product created.';
              }
              renderProducts();
              resetEditor();
            } catch (e) {
              editorStatus.textContent = 'Save failed: ' + e.message;
            }
          });
        }

        if (resetBtn) {
          resetBtn.addEventListener('click', function () {
            resetEditor();
          });
        }

        loadMe();
      })();
    </script>
  </body>
</html>
